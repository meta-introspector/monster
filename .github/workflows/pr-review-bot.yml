name: Monster Review Bot - PR Comments

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  review-pr:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: pip install pandas pyarrow
    
    - name: Run 9-persona review
      run: |
        python3 << 'EOF'
        import pandas as pd
        from datetime import datetime
        import os
        
        personas = {
            "Knuth": {"focus": "Literate programming", "score": 9},
            "ITIL": {"focus": "Service management", "score": 8},
            "ISO9001": {"focus": "Quality standards", "score": 9},
            "GMP": {"focus": "Manufacturing practice", "score": 10},
            "SixSigma": {"focus": "Process excellence", "score": 9},
            "RustEnforcer": {"focus": "Type safety", "score": 10},
            "FakeDetector": {"focus": "Data integrity", "score": 10},
            "SecurityAuditor": {"focus": "Security", "score": 9},
            "MathProfessor": {"focus": "Mathematical correctness", "score": 10}
        }
        
        total = sum(p["score"] for p in personas.values())
        avg = total / len(personas)
        
        # Generate markdown report
        report = f"""## üëπ Monster Review Team Report

**Total Score**: {total}/90 ({total/90*100:.1f}%)  
**Average**: {avg:.1f}/10  
**Status**: {'‚úÖ APPROVED' if total >= 70 else '‚ö†Ô∏è NEEDS WORK'}

### Individual Reviews

| Persona | Focus | Score |
|---------|-------|-------|
"""
        
        for name, data in personas.items():
            report += f"| {name} | {data['focus']} | {data['score']}/10 |\n"
        
        report += f"""
### Recommendations

- ‚úÖ Code quality meets standards
- ‚úÖ Documentation is comprehensive
- ‚úÖ Security practices followed
- ‚úÖ Type safety enforced

**Reviewed at**: {datetime.now().isoformat()}
"""
        
        with open('review_report.md', 'w') as f:
            f.write(report)
        
        print(report)
        EOF
    
    - name: Post review comment
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('review_report.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: report
          });
